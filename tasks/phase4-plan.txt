Plan: Phase 4 — CLI Entry Point & Commands                                                          │
│                                                                                                     │
│ Context                                                                                             │
│                                                                                                     │
│ Phases 1–3 are complete. The project has core lib modules (constants, network, derivation,          │
│ wallet-config, cli-config, facade, balance-subscription) and UI modules (colors, format, spinner,   │
│ art, animate) with 124 passing tests. Phase 4 wires everything into a usable CLI with npm run       │
│ wallet -- <command>.                                                                                │
│                                                                                                     │
│ No external CLI frameworks — raw process.argv parsing. stdout for pipeable data, stderr for         │
│ status/animations.                                                                                  │
│                                                                                                     │
│ New Shared Lib Modules                                                                              │
│                                                                                                     │
│ 1. src/lib/argv.ts — Argument Parser                                                                │
│                                                                                                     │
│ Minimal parser for process.argv.slice(2):                                                           │
│ - ParsedArgs interface: command, subcommand, positionals[], flags: Record<string, string | true>    │
│ - parseArgs(argv?) — first positional = command, second = subcommand, --key value pairs             │
│ - getFlag(args, name) — returns string value or undefined                                           │
│ - hasFlag(args, name) — boolean check                                                               │
│ - requireFlag(args, name, description) — throws descriptive error if missing                        │
│                                                                                                     │
│ 2. src/lib/resolve-network.ts — Network Resolution Chain                                            │
│                                                                                                     │
│ Implements the 5-step priority from DESIGN.md:                                                      │
│ 1. --network flag (explicit)                                                                        │
│ 2. Wallet file's stored network                                                                     │
│ 3. Auto-detect from address prefix                                                                  │
│ 4. Default from ~/.midnight/config.json                                                             │
│ 5. Fallback: 'undeployed'                                                                           │
│                                                                                                     │
│ Exports resolveNetworkName(ctx) and resolveNetwork(ctx) (name + full config).                       │
│                                                                                                     │
│ 3. src/lib/derive-address.ts — Address Derivation Helper                                            │
│                                                                                                     │
│ deriveUnshieldedAddress(seedBuffer, networkName, keyIndex?) — wraps HD derivation + keystore +      │
│ PublicKey into one call returning the bech32m address string. Supports variable --index for the     │
│ address command. Maps NetworkName → NetworkId.NetworkId internally (lowercase, unlike facade.ts     │
│ which maps from Pascal-cased networkConfig.networkId).                                              │
│                                                                                                     │
│ Entry Point                                                                                         │
│                                                                                                     │
│ src/wallet.ts                                                                                       │
│                                                                                                     │
│ - Parses argv, dispatches to command handler via switch                                             │
│ - Dynamic imports for lazy loading: await import('./commands/generate.ts')                          │
│ - Top-level .catch() formats errors with errorBox() and exits code 1                                │
│ - help is default when no command given (shows logo animation)                                      │
│ - Catches --help/-h globally                                                                        │
│                                                                                                     │
│ Command Handlers                                                                                    │
│                                                                                                     │
│ Each file in src/commands/ exports a default async function receiving ParsedArgs.                   │
│                                                                                                     │
│ commands/help.ts                                                                                    │
│                                                                                                     │
│ - General: logo animation (stderr) + command table (stdout)                                         │
│ - Specific: wallet help balance shows that command's usage, flags, examples                         │
│ - COMMAND_SPECS constant as single source of truth for help text                                    │
│                                                                                                     │
│ commands/generate.ts                                                                                │
│                                                                                                     │
│ Three modes:                                                                                        │
│ - Random (default): generateMnemonic(wordlist, 256) → mnemonicToSeedSync().slice(0, 32)             │
│ - --seed <hex>: validate 64 hex chars, create Buffer                                                │
│ - --mnemonic "...": validate, derive seed                                                           │
│                                                                                                     │
│ Flow: resolve network → derive address → save wallet config → display address (stdout),             │
│ mnemonic/seed warning (stderr)                                                                      │
│                                                                                                     │
│ commands/info.ts                                                                                    │
│                                                                                                     │
│ Load wallet config → display address, network, created date, file path. No secrets shown.           │
│                                                                                                     │
│ commands/balance.ts                                                                                 │
│                                                                                                     │
│ Load address from positional arg or wallet file → resolve network → determine indexer WS URL →      │
│ spinner → checkBalance() with progress → display balances (stdout)                                  │
│                                                                                                     │
│ commands/address.ts                                                                                 │
│                                                                                                     │
│ --seed (required), --network, --index → derive address → bare address to stdout (pipeable),         │
│ formatted details to stderr                                                                         │
│                                                                                                     │
│ commands/genesis-address.ts                                                                         │
│                                                                                                     │
│ Resolve network → derive address using GENESIS_SEED → output address                                │
│                                                                                                     │
│ commands/inspect-cost.ts                                                                            │
│                                                                                                     │
│ LedgerParameters.initialParameters() → probeDimension() technique (from reference script) → display │
│  block limits with formatted output                                                                 │
│                                                                                                     │
│ commands/config.ts                                                                                  │
│                                                                                                     │
│ config get <key> → getConfigValue() → stdout                                                        │
│ config set <key> <value> → setConfigValue() → success message (stderr)                              │
│                                                                                                     │
│ Tests                                                                                               │
│                                                                                                     │
│ src/__tests__/argv.test.ts                                                                          │
│                                                                                                     │
│ - Parse command, subcommand, positionals                                                            │
│ - Parse --flag value and boolean --flag                                                             │
│ - Empty argv, flag at end of argv                                                                   │
│ - requireFlag throws, getFlag returns undefined for missing                                         │
│                                                                                                     │
│ src/__tests__/resolve-network.test.ts                                                               │
│                                                                                                     │
│ - Each priority step in the chain                                                                   │
│ - Flag overrides everything                                                                         │
│ - Invalid flag throws with valid network list                                                       │
│ - Fallback to 'undeployed'                                                                          │
│                                                                                                     │
│ src/__tests__/derive-address.test.ts                                                                │
│                                                                                                     │
│ - Known address for genesis seed per network                                                        │
│ - Custom key index support                                                                          │
│ - Invalid seed throws                                                                               │
│ - Correct bech32m prefix per network                                                                │
│                                                                                                     │
│ Update tasks/todo.md                                                                                │
│                                                                                                     │
│ Check off Phase 3/3b items, keep Phase 4 items as-is for tracking during implementation.            │
│                                                                                                     │
│ Implementation Order                                                                                │
│                                                                                                     │
│ 1. argv.ts + argv.test.ts                                                                           │
│ 2. resolve-network.ts + resolve-network.test.ts                                                     │
│ 3. derive-address.ts + derive-address.test.ts                                                       │
│ 4. commands/help.ts                                                                                 │
│ 5. commands/config.ts                                                                               │
│ 6. commands/inspect-cost.ts                                                                         │
│ 7. commands/genesis-address.ts                                                                      │
│ 8. commands/address.ts                                                                              │
│ 9. commands/info.ts                                                                                 │
│ 10. commands/generate.ts                                                                            │
│ 11. commands/balance.ts                                                                             │
│ 12. wallet.ts (entry point)                                                                         │
│ 13. Typecheck + full test run                                                                       │
│                                                                                                     │
│ Verification                                                                                        │
│                                                                                                     │
│ - npm run typecheck passes                                                                          │
│ - npm test — all existing + new tests pass                                                          │
│ - Manual: npm run wallet -- help shows logo + command table                                         │
│ - Manual: npm run wallet -- generate --network undeployed creates wallet                            │
│ - Manual: npm run wallet -- info shows wallet details                                               │
│ - Manual: npm run wallet -- genesis-address --network undeployed shows address                      │
│ - Manual: npm run wallet -- config set network preprod + config get network       